name: Sync Upstream

on:
  schedule:
    # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ (UTC æ—¶é—´)
    - cron: '0 * * * *'
  workflow_dispatch:
    # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      dry_run:
        description: 'Dry run mode (åªæ£€æŸ¥ä¸æŽ¨é€)'
        required: false
        default: 'false'
        type: boolean

env:
  UPSTREAM_REPO: 'Wei-Shaw/claude-relay-service'
  UPSTREAM_BRANCH: 'main'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || \
          git remote set-url upstream https://github.com/${{ env.UPSTREAM_REPO }}.git

      - name: Fetch upstream
        run: git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      - name: Check for updates
        id: check
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/${{ env.UPSTREAM_BRANCH }})
          echo "behind=$BEHIND" >> $GITHUB_OUTPUT

          if [ "$BEHIND" -eq 0 ]; then
            echo "status=up-to-date" >> $GITHUB_OUTPUT
            echo "::notice::Already up to date with upstream"
          else
            echo "status=needs-sync" >> $GITHUB_OUTPUT
            echo "::notice::Behind upstream by $BEHIND commits"

            # èŽ·å–æ–°æäº¤ä¿¡æ¯
            echo "## New commits from upstream:" >> $GITHUB_STEP_SUMMARY
            git log --oneline HEAD..upstream/${{ env.UPSTREAM_BRANCH }} >> $GITHUB_STEP_SUMMARY
          fi

      - name: Attempt rebase
        id: rebase
        if: steps.check.outputs.status == 'needs-sync'
        run: |
          echo "Attempting rebase onto upstream/${{ env.UPSTREAM_BRANCH }}..."

          if git rebase upstream/${{ env.UPSTREAM_BRANCH }}; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "::notice::Rebase successful"
          else
            echo "result=conflict" >> $GITHUB_OUTPUT
            echo "::error::Rebase failed due to conflicts"
            git rebase --abort
            exit 1
          fi
        continue-on-error: true

      - name: Setup Node.js
        if: steps.rebase.outputs.result == 'success'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.rebase.outputs.result == 'success'
        run: npm ci

      - name: Install web dependencies
        if: steps.rebase.outputs.result == 'success'
        run: cd web/admin-spa && npm ci

      - name: Build web interface
        id: build
        if: steps.rebase.outputs.result == 'success'
        run: |
          if npm run build:web; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "::notice::Build successful"
          else
            echo "result=failed" >> $GITHUB_OUTPUT
            echo "::error::Build failed"
            exit 1
          fi
        continue-on-error: true

      - name: Verify brand files
        id: verify
        if: steps.build.outputs.result == 'success'
        run: |
          echo "Verifying brand customization files..."

          ERRORS=0

          # æ£€æŸ¥ logo
          if [ ! -f "web/admin-spa/public/logo.svg" ]; then
            echo "::error::Missing logo.svg"
            ERRORS=$((ERRORS + 1))
          fi

          # æ£€æŸ¥ favicon
          if [ ! -f "web/admin-spa/public/favicon.ico" ]; then
            echo "::error::Missing favicon.ico"
            ERRORS=$((ERRORS + 1))
          fi

          # æ£€æŸ¥å“ç‰Œåç§°
          if ! grep -q "Whoos Solutions" web/admin-spa/index.html; then
            echo "::error::Brand name missing in index.html"
            ERRORS=$((ERRORS + 1))
          fi

          # æ£€æŸ¥é…è‰²
          if ! grep -q "#b31b1b\|#e4002b\|#ffcd00" web/admin-spa/src/styles/global.css; then
            echo "::warning::Brand colors may have been modified in global.css"
          fi

          if [ $ERRORS -gt 0 ]; then
            echo "result=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "result=success" >> $GITHUB_OUTPUT
            echo "::notice::Brand verification passed"
          fi
        continue-on-error: true

      - name: Get upstream version
        id: version
        if: steps.verify.outputs.result == 'success'
        run: |
          # èŽ·å–æœ€æ–°çš„ç‰ˆæœ¬æ ‡ç­¾
          VERSION=$(git describe --tags upstream/${{ env.UPSTREAM_BRANCH }} --abbrev=0 2>/dev/null || echo "unknown")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "::notice::Upstream version: $VERSION"

      - name: Update sync record
        if: steps.verify.outputs.result == 'success'
        run: |
          DATE=$(date +%Y-%m-%d)
          VERSION="${{ steps.version.outputs.version }}"
          COMMITS="${{ steps.check.outputs.behind }}"

          # åœ¨ "ä¸‹æ¬¡æ›´æ–°è¯·åœ¨æ­¤æ·»åŠ è®°å½•" ä¹‹å‰æ’å…¥æ–°è®°å½•
          sed -i "/\*\*ä¸‹æ¬¡æ›´æ–°è¯·åœ¨æ­¤æ·»åŠ è®°å½•\*\*/i | $DATE | $VERSION | åŒæ­¥ $COMMITS ä¸ªæäº¤ (è‡ªåŠ¨) | æ— å†²çª | âœ… æˆåŠŸ | GitHub Actions è‡ªåŠ¨åŒæ­¥ |" SYNC_UPSTREAM.md

          git add SYNC_UPSTREAM.md
          git commit -m "docs: æ›´æ–°åŒæ­¥è®°å½• - $VERSION (è‡ªåŠ¨åŒæ­¥)"

      - name: Push changes
        if: steps.verify.outputs.result == 'success' && github.event.inputs.dry_run != 'true'
        run: |
          echo "Pushing changes to origin..."
          git push origin ${{ env.UPSTREAM_BRANCH }} --force-with-lease
          echo "::notice::Successfully pushed to origin"

      - name: Dry run notice
        if: steps.verify.outputs.result == 'success' && github.event.inputs.dry_run == 'true'
        run: |
          echo "::warning::Dry run mode - changes were NOT pushed"
          echo "## Dry Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "Rebase and build successful, but changes were not pushed (dry run mode)" >> $GITHUB_STEP_SUMMARY

      - name: Create issue on failure
        if: failure() && steps.check.outputs.status == 'needs-sync'
        uses: actions/github-script@v7
        with:
          script: |
            const rebaseResult = '${{ steps.rebase.outputs.result }}';
            const buildResult = '${{ steps.build.outputs.result }}';
            const verifyResult = '${{ steps.verify.outputs.result }}';
            const behind = '${{ steps.check.outputs.behind }}';

            let title, body;

            if (rebaseResult === 'conflict') {
              title = 'ðŸ”´ ä¸Šæ¸¸åŒæ­¥å¤±è´¥: Rebase å†²çª';
              body = `## åŒæ­¥å¤±è´¥é€šçŸ¥\n\nä¸Šæ¸¸æœ‰ ${behind} ä¸ªæ–°æäº¤ï¼Œä½†è‡ªåŠ¨ rebase é‡åˆ°å†²çªã€‚\n\n### éœ€è¦æ‰‹åŠ¨å¤„ç†\n\nè¯·åœ¨æœ¬åœ°æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\n\n\`\`\`bash\ncd /Users/jeffreyhu/DEV/claude-relay-service\ngit fetch upstream\ngit rebase upstream/main\n# è§£å†³å†²çªåŽ\ngit add .\ngit rebase --continue\nnpm run build:web\ngit push origin main --force-with-lease\n\`\`\`\n\n### å†²çªå¤„ç†ç­–ç•¥\n- UI/æ ·å¼æ–‡ä»¶ â†’ ä¿ç•™æˆ‘ä»¬çš„ç‰ˆæœ¬ (\`git checkout --ours\`)\n- åŠŸèƒ½ä»£ç  â†’ ä¿ç•™ä¸Šæ¸¸ç‰ˆæœ¬ (\`git checkout --theirs\`)`;
            } else if (buildResult === 'failed') {
              title = 'ðŸ”´ ä¸Šæ¸¸åŒæ­¥å¤±è´¥: æž„å»ºé”™è¯¯';
              body = `## åŒæ­¥å¤±è´¥é€šçŸ¥\n\nRebase æˆåŠŸï¼Œä½† \`npm run build:web\` æž„å»ºå¤±è´¥ã€‚\n\nè¯·æ£€æŸ¥æž„å»ºæ—¥å¿—å¹¶æ‰‹åŠ¨ä¿®å¤ã€‚`;
            } else if (verifyResult === 'failed') {
              title = 'ðŸ”´ ä¸Šæ¸¸åŒæ­¥å¤±è´¥: å“ç‰Œæ–‡ä»¶éªŒè¯å¤±è´¥';
              body = `## åŒæ­¥å¤±è´¥é€šçŸ¥\n\nRebase å’Œæž„å»ºæˆåŠŸï¼Œä½†å“ç‰Œå®šåˆ¶æ–‡ä»¶éªŒè¯å¤±è´¥ã€‚\n\nå¯èƒ½æ˜¯ä¸Šæ¸¸æ›´æ–°è¦†ç›–äº†æˆ‘ä»¬çš„å®šåˆ¶å†…å®¹ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ï¼š\n- \`web/admin-spa/public/logo.svg\`\n- \`web/admin-spa/public/favicon.ico\`\n- \`web/admin-spa/index.html\` (å“ç‰Œåç§°)\n- \`web/admin-spa/src/styles/global.css\` (é…è‰²)`;
            } else {
              title = 'ðŸ”´ ä¸Šæ¸¸åŒæ­¥å¤±è´¥: æœªçŸ¥é”™è¯¯';
              body = `## åŒæ­¥å¤±è´¥é€šçŸ¥\n\nè¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚`;
            }

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æœªå…³é—­çš„åŒæ­¥å¤±è´¥ issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'sync-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['sync-failure']
              });
            } else {
              // æ›´æ–°çŽ°æœ‰ issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## æ–°çš„åŒæ­¥å°è¯•å¤±è´¥\n\n${body}\n\n---\næ—¶é—´: ${new Date().toISOString()}`
              });
            }

      - name: Summary
        if: always()
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Check updates | ${{ steps.check.outputs.status }} (${{ steps.check.outputs.behind }} commits behind) |" >> $GITHUB_STEP_SUMMARY
          echo "| Rebase | ${{ steps.rebase.outputs.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build.outputs.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verify | ${{ steps.verify.outputs.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
