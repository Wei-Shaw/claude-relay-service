name: Dev Private Deploy

on:
  push:
    branches-ignore:
      - 'gh-pages'  # 忽略非代码分支

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 方案更新：显式信任自签名证书，解决 Docker 协议协商问题
      - name: Trust Self-Signed Certificate
        run: |
          # 获取服务器证书
          echo "Fetching certificate from 154.12.35.169:5000..."
          echo -n | openssl s_client -showcerts -connect 154.12.35.169:5000 2>/dev/null | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > custom-registry.crt

          # 验证证书内容是否获取成功
          if [ ! -s custom-registry.crt ]; then
            echo "Failed to fetch certificate!"
            exit 1
          fi

          # 安装证书到系统信任库
          sudo cp custom-registry.crt /usr/local/share/ca-certificates/custom-registry.crt
          sudo update-ca-certificates

          # 关键修改：不再配置 insecure-registries
          # 因为证书已被信任，Docker 应将其视为正常的 HTTPS 仓库
          # 之前配置 insecure-registries 反而导致 Docker 优先尝试 HTTP (400)

          # 重启 Docker 确保加载新的 CA 证书
          sudo systemctl restart docker
          while ! docker info > /dev/null 2>&1; do echo "Waiting for Docker to start..."; sleep 1; done

      - name: Check Registry Connectivity
        run: |
          echo "Checking HTTP..."
          curl -v http://154.12.35.169:5000/v2/ || true
          echo "Checking HTTPS (insecure)..."
          curl -v -k https://154.12.35.169:5000/v2/ || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
          # BuildKit 容器内可能没有宿主机的 CA 证书，所以这里允许 insecure 以确保 push 成功
          config-inline: |
            [registry."154.12.35.169:5000"]
              insecure = true

      - name: Log in to Private Registry (Manual)
        run: |
          echo "${{ secrets.PRIVATE_REGISTRY_PASSWORD }}" | docker login 154.12.35.169:5000 -u "${{ secrets.PRIVATE_REGISTRY_USERNAME }}" --password-stdin

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: 154.12.35.169:5000/claude-relay-service
          # 生成两种 tag:
          # 1. 分支名 (例如: dev, fix-bug) - 总是指向该分支最新代码
          # 2. commit hash (例如: sha-7b3f1a2) -用于回溯历史版本
          tags: |
            type=ref,event=branch
            type=sha,format=short,prefix=dev-

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
