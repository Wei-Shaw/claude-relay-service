name: Dev Private Deploy

on:
  push:
    branches-ignore:
      - 'gh-pages'  # 忽略非代码分支

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 新增步骤：配置宿主机 Docker Daemon 信任不安全仓库
      - name: Configure Docker Daemon
        run: |
          sudo mkdir -p /etc/docker
          # 读取现有配置（如果存在）或者创建新的，并添加 insecure-registries
          if [ -f /etc/docker/daemon.json ]; then
            sudo cat /etc/docker/daemon.json | jq '."insecure-registries" += ["154.12.35.169:5000"]' | sudo tee /etc/docker/daemon.json.tmp
            sudo mv /etc/docker/daemon.json.tmp /etc/docker/daemon.json
          else
            echo '{"insecure-registries": ["154.12.35.169:5000"]}' | sudo tee /etc/docker/daemon.json
          fi

          # 打印配置以验证
          cat /etc/docker/daemon.json

          # 重启 Docker 服务使配置生效
          sudo systemctl restart docker

          # 等待 Docker 启动
          while ! docker info > /dev/null 2>&1; do echo "Waiting for Docker to start..."; sleep 1; done

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # 这里依然保留 BuildKit 的配置，确保构建阶段也信任
          driver-opts: |
            network=host
          config-inline: |
            [registry."154.12.35.169:5000"]
              http = true
              insecure = true

      - name: Log in to Private Registry
        uses: docker/login-action@v3
        with:
          registry: 154.12.35.169:5000
          username: ${{ secrets.PRIVATE_REGISTRY_USERNAME }}
          password: ${{ secrets.PRIVATE_REGISTRY_PASSWORD }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: 154.12.35.169:5000/claude-relay-service
          # 生成两种 tag:
          # 1. 分支名 (例如: dev, fix-bug) - 总是指向该分支最新代码
          # 2. commit hash (例如: sha-7b3f1a2) -用于回溯历史版本
          tags: |
            type=ref,event=branch
            type=sha,format=short,prefix=dev-

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
