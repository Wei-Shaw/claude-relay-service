name: Auto Deploy to Server

on:
  push:
    branches:
      - main  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
      # - dev  # å¦‚æœéœ€è¦éƒ¨ç½² dev åˆ†æ”¯ï¼Œå–æ¶ˆæ³¨é‡Š
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    # è·³è¿‡åŒ…å« [skip deploy] çš„æäº¤
    if: "!contains(github.event.head_commit.message, '[skip deploy]')"

    steps:
      - name: å¼€å§‹éƒ¨ç½²
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨..."
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        env:
          BRANCH: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: BRANCH,COMMIT_SHA,COMMIT_MSG
          script_stop: true  # è„šæœ¬å‡ºé”™æ—¶åœæ­¢
          command_timeout: 30m  # è¶…æ—¶æ—¶é—´
          script: |
            echo "========================================="
            echo "ğŸš€ Claude Relay Service è‡ªåŠ¨éƒ¨ç½²å¼€å§‹"
            echo "========================================="
            echo "ğŸ“Œ åˆ†æ”¯: $BRANCH"
            echo "ğŸ“Œ æäº¤: $COMMIT_SHA"
            echo "ğŸ“Œ ä¿¡æ¯: $COMMIT_MSG"
            echo "ğŸ“Œ æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""

            # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
            cd ${{ secrets.DEPLOY_PATH || '/home/user/claude-relay-service' }}

            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            bash scripts/deploy.sh

            echo ""
            echo "========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "========================================="

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "æœåŠ¡å™¨: ${{ secrets.SSH_HOST }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"

      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—"
          exit 1

      # å¯é€‰ï¼šå‘é€ Telegram é€šçŸ¥
      - name: å‘é€ Telegram é€šçŸ¥
        if: always() && secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != ''
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ${{ job.status == 'success' && 'âœ…' || 'âŒ' }} *Claude Relay éƒ¨ç½²${{ job.status == 'success' && 'æˆåŠŸ' || 'å¤±è´¥' }}*

            ğŸ“¦ åˆ†æ”¯: `${{ github.ref_name }}`
            ğŸ’¬ æäº¤: ${{ github.event.head_commit.message }}
            ğŸ‘¤ ä½œè€…: ${{ github.actor }}
            ğŸ”— [æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
