# 会话历史筛选优化方案（最小改动版）

## 目标
在不改动 Redis 结构的前提下，为会话历史页提供“标签 → API Key → 会话标题”三级筛选能力，支持用户先缩小范围再查看会话列表与详情。

## 后端变更
- **接口扩展**：`GET /api/history/sessions` 增加可选查询参数 `keyword`，用于模糊匹配会话标题；旧请求不携带该参数时保持原行为。
- **服务层调整**：
  - `historyService.listSessions({ apiKeyId, page, pageSize, keyword })`
    - 透传 `keyword` 参数；若存在，则在拿到 Redis 返回的会话后进行大小写不敏感过滤，并重新计算 `total`。
  - `sessionStore.listSessions(apiKeyId, { page, pageSize, keyword })`
    - 默认保持 `zrevrange` 按时间分页；当 `keyword` 存在时，改为 `zrevrange(indexKey, 0, -1)` 取出所有会话，由上层过滤后再做分页。
- **兼容性**：查询逻辑仅在存在 `keyword` 时生效，原有调用（仅带 `apiKeyId`）无影响，可随时回退。

## 前端变更（`HistoryView.vue`）
- 顶部新增筛选面板，依次包含：
  1. **标签单选**（默认“全部标签”）：过滤本地 API Key 列表。
  2. **API Key 可搜索下拉**（增强 `CustomDropdown`）：只展示当前标签下的 key，并支持输入关键字过滤。
  3. **会话标题搜索输入 + 搜索按钮**：用户点击按钮或回车时才请求接口（附带 `keyword`），无持续 debounce。
  4. **重置按钮**：清空标签/API Key/keyword，并自动触发一次请求回到默认列表。
- 会话列表与详情布局保持“左列表、右详情”，继续支持深浅主题样式。
- 默认行为：首次加载“全部标签 + 第一个 API Key”，如果存在外部跳转带 `apiKeyId`，优先定位并选中。

## 不变内容
- Redis Key 结构与清理机制；
- 现有会话记录、sticky session、消息读取逻辑；
- 前端分页与详情加载流程。

## 验证建议
1. 默认加载：不传 `keyword`，确认返回与旧版一致。
2. 标签选取 + API Key 过滤：确认 API Key 下拉只剩对应标签内的条目。
3. 关键字搜索：输入后点击“搜索”按钮或回车触发查询；重置应立即恢复完整列表。
4. 主题切换：浅色/深色模式下筛选面板样式正确。
