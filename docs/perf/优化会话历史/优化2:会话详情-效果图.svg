<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1400">
  <!-- 定义样式 -->
  <defs>
    <style>
      .title { font-family: Arial, sans-serif; font-size: 24px; font-weight: bold; fill: #1f2937; }
      .subtitle { font-family: Arial, sans-serif; font-size: 16px; fill: #6b7280; }
      .label { font-family: Arial, sans-serif; font-size: 14px; fill: #374151; }
      .text { font-family: Arial, sans-serif; font-size: 13px; fill: #4b5563; }
      .small-text { font-family: Arial, sans-serif; font-size: 11px; fill: #6b7280; }
      .user-bg { fill: #f3f4f6; stroke: #d1d5db; }
      .assistant-bg { fill: #eef2ff; stroke: #c7d2fe; }
      .system-bg { fill: #fef3c7; stroke: #fde047; }
      .thinking-bg { fill: #f5f3ff; stroke: #ddd6fe; }
      .button { fill: #3b82f6; }
      .button-text { fill: white; font-size: 12px; font-weight: 500; }
      .icon { fill: #6b7280; }
      .arrow { fill: none; stroke: #9ca3af; stroke-width: 2; marker-end: url(#arrowhead); }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#9ca3af" />
    </marker>
  </defs>

  <!-- 标题 -->
  <text x="600" y="40" text-anchor="middle" class="title">会话消息分组与分类优化方案</text>
  <text x="600" y="70" text-anchor="middle" class="subtitle">按对话轮次分组 + 消息类型智能识别</text>

  <!-- ========== 对话轮次 1 ========== -->
  <text x="50" y="120" class="label" font-weight="bold">📩 对话轮次 #1</text>

  <!-- 用户消息 -->
  <rect x="50" y="140" width="1100" height="80" rx="8" class="user-bg" stroke-width="2"/>
  <text x="70" y="165" class="label" font-weight="600">👤 用户</text>
  <text x="1080" y="165" text-anchor="end" class="small-text">2025-10-08 18:09:14</text>
  <text x="70" y="190" class="text">你好</text>
  <text x="70" y="210" class="small-text">模型: claude-3-5-haiku-20241022</text>

  <!-- AI 回复组（折叠状态） -->
  <rect x="50" y="240" width="1100" height="120" rx="8" class="assistant-bg" stroke-width="2"/>
  <text x="70" y="265" class="label" font-weight="600">🤖 Claude</text>
  <text x="1080" y="265" text-anchor="end" class="small-text">2025-10-08 18:09:15</text>

  <!-- 折叠的思考过程提示 -->
  <rect x="70" y="280" width="1040" height="30" rx="4" class="thinking-bg" stroke-width="1" opacity="0.6"/>
  <text x="90" y="300" class="small-text">💭 AI 思考过程已折叠</text>
  <rect x="950" y="285" width="100" height="20" rx="4" fill="#8b5cf6"/>
  <text x="1000" y="299" text-anchor="middle" class="button-text">展开 ▼</text>

  <!-- 最终回复 -->
  <text x="70" y="335" class="text">Hello!</text>
  <text x="70" y="355" class="small-text">模型: claude-sonnet-4-20250514 | 结束原因: end_turn</text>

  <!-- ========== 对话轮次 2（展开状态） ========== -->
  <text x="50" y="420" class="label" font-weight="bold">📩 对话轮次 #2</text>

  <!-- 用户消息 -->
  <rect x="50" y="440" width="1100" height="100" rx="8" class="user-bg" stroke-width="2"/>
  <text x="70" y="465" class="label" font-weight="600">👤 用户</text>
  <text x="1080" y="465" text-anchor="end" class="small-text">2025-10-08 18:09:14</text>
  <text x="70" y="490" class="text">帮我分析一下这个代码</text>
  <text x="70" y="510" class="small-text">模型: claude-3-5-haiku-20241022</text>
  <rect x="70" y="515" width="80" height="18" rx="9" fill="#3b82f6" opacity="0.1"/>
  <text x="110" y="527" text-anchor="middle" class="small-text" fill="#3b82f6">🔗 附件 1</text>

  <!-- 系统消息（可选显示） -->
  <rect x="50" y="560" width="1100" height="70" rx="8" class="system-bg" stroke-width="2" stroke-dasharray="5,5" opacity="0.8"/>
  <text x="70" y="585" class="label" font-weight="600">⚙️ 系统提醒</text>
  <text x="1080" y="585" text-anchor="end" class="small-text">自动隐藏</text>
  <text x="70" y="610" class="small-text" opacity="0.7">&lt;system-reminder&gt; This is a reminder that your todo list...</text>

  <!-- AI 回复组（展开状态） -->
  <rect x="50" y="650" width="1100" height="320" rx="8" class="assistant-bg" stroke-width="2"/>
  <text x="70" y="675" class="label" font-weight="600">🤖 Claude</text>
  <text x="1080" y="675" text-anchor="end" class="small-text">2025-10-08 18:09:18</text>

  <!-- 展开的思考过程 -->
  <rect x="70" y="690" width="1040" height="140" rx="4" class="thinking-bg" stroke-width="1"/>
  <text x="90" y="710" class="small-text" font-weight="600">💭 AI 思考过程</text>
  <rect x="950" y="695" width="100" height="20" rx="4" fill="#6b7280"/>
  <text x="1000" y="709" text-anchor="middle" class="button-text">收起 ▲</text>

  <!-- 思考过程内容 -->
  <rect x="90" y="725" width="1000" height="80" rx="4" fill="#faf5ff" stroke="#e9d5ff" stroke-width="1"/>
  <text x="110" y="745" class="small-text" font-family="monospace">{</text>
  <text x="130" y="765" class="small-text" font-family="monospace">"type": "tool_use",</text>
  <text x="130" y="785" class="small-text" font-family="monospace">"name": "read_file"</text>
  <text x="110" y="800" class="small-text" font-family="monospace">}</text>

  <!-- 最终回复 -->
  <rect x="70" y="845" width="1040" height="110" rx="4" fill="white" stroke="#c7d2fe" stroke-width="1"/>
  <text x="90" y="865" class="small-text" font-weight="600">✅ 最终回复</text>
  <text x="90" y="890" class="text">这段代码的主要功能是...</text>
  <text x="90" y="910" class="text">建议优化以下几点：</text>
  <text x="90" y="930" class="text">1. 使用 async/await 替代回调</text>
  <text x="90" y="950" class="small-text">模型: claude-sonnet-4-20250514 | Token: 1500 | 结束原因: end_turn</text>

  <!-- ========== 数据结构说明 ========== -->
  <text x="50" y="1020" class="label" font-weight="bold">📊 后端数据结构优化</text>

  <rect x="50" y="1040" width="1100" height="320" rx="8" fill="#f9fafb" stroke="#e5e7eb" stroke-width="2"/>

  <!-- 消息分类 -->
  <text x="80" y="1070" class="label" font-weight="600">1. 消息类型重新分类</text>
  <rect x="100" y="1080" width="500" height="180" rx="4" fill="white" stroke="#d1d5db" stroke-width="1"/>
  <text x="120" y="1105" class="text" font-family="monospace">message: {</text>
  <text x="140" y="1130" class="small-text" font-family="monospace">role: 'user' | 'assistant' | 'system',</text>
  <text x="140" y="1150" class="small-text" font-family="monospace">subtype: 'message' | 'thinking' | 'tool_use',</text>
  <text x="140" y="1170" class="small-text" font-family="monospace">content: '...',</text>
  <text x="140" y="1190" class="small-text" font-family="monospace">messageGroupId: 'group_xxx',</text>
  <text x="140" y="1210" class="small-text" font-family="monospace">isVisible: true | false</text>
  <text x="140" y="1230" class="small-text" font-family="monospace">requestId: 'req_xxx'</text>
  <text x="120" y="1250" class="text" font-family="monospace">}</text>

  <!-- 分组逻辑 -->
  <text x="650" y="1070" class="label" font-weight="600">2. 消息分组逻辑</text>
  <rect x="670" y="1080" width="450" height="120" rx="4" fill="white" stroke="#d1d5db" stroke-width="1"/>
  <text x="690" y="1105" class="small-text">• 按 requestId 聚合同一对话轮次</text>
  <text x="690" y="1130" class="small-text">• 用户消息作为分组起点</text>
  <text x="690" y="1155" class="small-text">• AI 的多条回复归入同一组</text>
  <text x="690" y="1180" class="small-text">• 系统消息可选择性隐藏</text>

  <!-- 前端渲染策略 -->
  <text x="80" y="1300" class="label" font-weight="600">3. 前端渲染策略</text>
  <rect x="100" y="1310" width="1000" height="40" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="1"/>
  <text x="120" y="1335" class="small-text">✓ 精简模式（默认）：只显示用户消息 + AI 最终回复，思考过程折叠</text>
  <text x="120" y="1355" class="small-text">✓ 详细模式：展开思考过程、工具调用、系统消息</text>

  <!-- 图例 -->
  <text x="50" y="1395" class="small-text" font-weight="600">图例：</text>
  <rect x="120" y="1382" width="80" height="18" rx="4" class="user-bg" stroke-width="1"/>
  <text x="160" y="1395" text-anchor="middle" class="small-text">用户消息</text>

  <rect x="220" y="1382" width="80" height="18" rx="4" class="assistant-bg" stroke-width="1"/>
  <text x="260" y="1395" text-anchor="middle" class="small-text">AI 回复</text>

  <rect x="320" y="1382" width="80" height="18" rx="4" class="thinking-bg" stroke-width="1"/>
  <text x="360" y="1395" text-anchor="middle" class="small-text">思考过程</text>

  <rect x="420" y="1382" width="80" height="18" rx="4" class="system-bg" stroke-width="1"/>
  <text x="460" y="1395" text-anchor="middle" class="small-text">系统消息</text>
</svg>
