# æ¶ˆæ¯åˆ†ç»„ä¸åˆ†ç±»ä¼˜åŒ–æ–¹æ¡ˆ - å½±å“èŒƒå›´åˆ†æ

## ğŸ“Š æ€»ä½“å½±å“è¯„ä¼°

| å±‚çº§ | å½±å“ç¨‹åº¦ | é£é™©ç­‰çº§ | å·¥ä½œé‡ |
|------|---------|---------|--------|
| **åç«¯é€»è¾‘** | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ ä½ | 4-6 å°æ—¶ |
| **æ•°æ®åº“/å­˜å‚¨** | ğŸŸ¢ å° | ğŸŸ¢ ä½ | 1-2 å°æ—¶ |
| **å‰ç«¯ UI** | ğŸ”´ é«˜ | ğŸŸ¡ ä¸­ | 6-8 å°æ—¶ |
| **å‘åå…¼å®¹** | ğŸŸ¢ å° | ğŸŸ¢ ä½ | 1 å°æ—¶ |

---

## ğŸ”§ åç«¯å½±å“èŒƒå›´

### 1. æ ¸å¿ƒæ–‡ä»¶ä¿®æ”¹

#### âœï¸ `src/services/history/historyService.js`

**å½±å“æ¨¡å—**ï¼šæ¶ˆæ¯é‡‡é›†ä¸åˆ†ç±»é€»è¾‘

**éœ€è¦ä¿®æ”¹çš„å‡½æ•°**ï¼š

```javascript
// 1. HistoryRecorder.init() - ç”¨æˆ·æ¶ˆæ¯é‡‡é›†
//    æ–°å¢ï¼šæ£€æµ‹ç³»ç»Ÿæ¶ˆæ¯ç±»å‹
async init() {
  const userMessage = HistoryRecorder.extractUserMessage(this.requestBody)

  // ğŸ†• æ–°å¢ï¼šæ£€æµ‹æ˜¯å¦ä¸ºç³»ç»Ÿæ¶ˆæ¯
  const messageType = this.detectMessageType(userMessage.content)

  await sessionStore.appendMessage({
    sessionId: this.sessionId,
    message: {
      role: messageType.role,        // 'user' | 'system'
      subtype: messageType.subtype,  // 'message' | 'reminder'
      content: userMessage.content,
      messageGroupId: this.generateGroupId(), // ğŸ†• æ–°å¢åˆ†ç»„ID
      isVisible: messageType.isVisible,       // ğŸ†• æ–°å¢å¯è§æ€§
      // ...
    }
  })
}

// 2. recordAssistantResponse() - AI æ¶ˆæ¯é‡‡é›†
//    æ–°å¢ï¼šåŒºåˆ†æ€è€ƒè¿‡ç¨‹å’Œæœ€ç»ˆå›å¤
async recordAssistantResponse({ text, raw, finishReason, model, error }) {
  // ğŸ†• æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºæ€è€ƒè¿‡ç¨‹
  const isThinking = this.detectThinkingContent(text, raw)

  await sessionStore.appendMessage({
    sessionId: this.sessionId,
    message: {
      role: 'assistant',
      subtype: isThinking ? 'thinking' : 'message', // ğŸ†• æ–°å¢å­ç±»å‹
      content: text,
      messageGroupId: this.currentGroupId,          // ğŸ†• ä½¿ç”¨å½“å‰ç»„ID
      isVisible: !isThinking,                       // ğŸ†• æ€è€ƒè¿‡ç¨‹é»˜è®¤éšè—
      // ...
    }
  })
}

// ğŸ†• æ–°å¢å‡½æ•°
detectMessageType(content) {
  // æ£€æµ‹ <system-reminder>ã€<important>ã€<context> ç­‰æ ‡ç­¾
  if (/<system-reminder>/i.test(content)) {
    return { role: 'system', subtype: 'reminder', isVisible: false }
  }
  // ... å…¶ä»–è§„åˆ™
  return { role: 'user', subtype: 'message', isVisible: true }
}

// ğŸ†• æ–°å¢å‡½æ•°
detectThinkingContent(text, raw) {
  // æ£€æµ‹ JSON æ ¼å¼ã€å·¥å…·è°ƒç”¨ç­‰
  if (typeof raw === 'object' && raw.type === 'tool_use') {
    return true
  }
  if (/^\s*\{[\s\S]*\}\s*$/.test(text)) {
    return true
  }
  return false
}

// ğŸ†• æ–°å¢å‡½æ•°
generateGroupId() {
  return `group_${this.apiKey.id}_${this.requestId}_${Date.now()}`
}
```

**å½±å“è¯„ä¼°**ï¼š
- âœ… **å…¼å®¹æ€§**ï¼šåªå¢åŠ æ–°å­—æ®µï¼Œä¸ä¿®æ”¹ç°æœ‰é€»è¾‘
- âš ï¸ **å¤æ‚åº¦**ï¼šéœ€è¦ç¼–å†™æ¶ˆæ¯ç±»å‹æ£€æµ‹è§„åˆ™
- ğŸ”¢ **ä»£ç è¡Œæ•°**ï¼šçº¦ +100 è¡Œ

---

#### âœï¸ `src/services/history/sessionStore.js`

**å½±å“æ¨¡å—**ï¼šæ¶ˆæ¯å­˜å‚¨ä¸æŸ¥è¯¢

**éœ€è¦ä¿®æ”¹çš„å‡½æ•°**ï¼š

```javascript
// 1. appendMessage() - ä¿å­˜æ¶ˆæ¯
//    ä¿®æ”¹ï¼šæ”¯æŒæ–°å­—æ®µï¼ˆmessageGroupId, subtype, isVisibleï¼‰
const appendMessage = async ({ apiKeyId, sessionId, message }) => {
  // ç°æœ‰é€»è¾‘æ— éœ€ä¿®æ”¹ï¼ŒRedis è‡ªåŠ¨æ”¯æŒæ–°å­—æ®µ
  const payload = JSON.stringify({
    ...message,
    storedAt: new Date().toISOString()
  })

  await client.multi()
    .rpush(listKey, payload)
    .exec()
}

// 2. getSessionMessages() - æŸ¥è¯¢æ¶ˆæ¯
//    ä¿®æ”¹ï¼šè¿”å›æ—¶è§£ææ–°å­—æ®µ
const getSessionMessages = async (sessionId) => {
  const messages = await client.lrange(sessionMessagesKey(sessionId), 0, -1)
  return messages.map(msg => {
    const parsed = JSON.parse(msg)
    // ğŸ†• ä¸ºæ—§æ•°æ®è¡¥å……é»˜è®¤å€¼
    return {
      ...parsed,
      messageGroupId: parsed.messageGroupId || `legacy_${parsed.storedAt}`,
      subtype: parsed.subtype || 'message',
      isVisible: parsed.isVisible !== undefined ? parsed.isVisible : true
    }
  })
}
```

**å½±å“è¯„ä¼°**ï¼š
- âœ… **å…¼å®¹æ€§**ï¼šæ—§æ•°æ®è‡ªåŠ¨è¡¥å……é»˜è®¤å€¼
- âœ… **æ€§èƒ½**ï¼šæ— é¢å¤–æŸ¥è¯¢ï¼Œä¸å½±å“æ€§èƒ½
- ğŸ”¢ **ä»£ç è¡Œæ•°**ï¼šçº¦ +20 è¡Œ

---

#### ğŸ†• æ–°å¢æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰ï¼š`src/services/history/messageClassifier.js`

**ç›®çš„**ï¼šç‹¬ç«‹çš„æ¶ˆæ¯åˆ†ç±»é€»è¾‘ï¼Œä¾¿äºç»´æŠ¤

```javascript
// æ¶ˆæ¯åˆ†ç±»è§„åˆ™é…ç½®
const MESSAGE_PATTERNS = {
  systemReminder: /<system-reminder>[\s\S]*?<\/system-reminder>/i,
  importantNote: /<important>[\s\S]*?<\/important>/i,
  toolUse: /^\s*\{[\s\S]*"type"\s*:\s*"tool_use"[\s\S]*\}\s*$/,
  jsonContent: /^\s*\{[\s\S]*\}\s*$/
}

export function classifyMessage(content, raw) {
  // ç³»ç»Ÿæ¶ˆæ¯æ£€æµ‹
  if (MESSAGE_PATTERNS.systemReminder.test(content)) {
    return { role: 'system', subtype: 'reminder', isVisible: false }
  }

  // AI æ€è€ƒè¿‡ç¨‹æ£€æµ‹
  if (raw?.type === 'tool_use' || MESSAGE_PATTERNS.jsonContent.test(content)) {
    return { role: 'assistant', subtype: 'thinking', isVisible: false }
  }

  // é»˜è®¤ï¼šæ­£å¸¸æ¶ˆæ¯
  return { role: 'user', subtype: 'message', isVisible: true }
}
```

**å½±å“è¯„ä¼°**ï¼š
- âœ… **å¯ç»´æŠ¤æ€§**ï¼šè§„åˆ™é›†ä¸­ç®¡ç†ï¼Œæ˜“äºæ‰©å±•
- ğŸ”¢ **ä»£ç è¡Œæ•°**ï¼šçº¦ +50 è¡Œ

---

### 2. API æ¥å£å½±å“

#### ğŸ“¡ `GET /api/history/sessions/:id/messages`

**å“åº”æ•°æ®å˜åŒ–**ï¼š

**å½“å‰è¿”å›**ï¼š
```json
[
  {
    "role": "user",
    "content": "ä½ å¥½",
    "createdAt": "2025-10-08T18:09:14Z",
    "model": "claude-3-5-haiku-20241022"
  }
]
```

**ä¼˜åŒ–åè¿”å›**ï¼š
```json
[
  {
    "role": "user",
    "subtype": "message",
    "messageGroupId": "group_123_req1_1736294354",
    "isVisible": true,
    "content": "ä½ å¥½",
    "createdAt": "2025-10-08T18:09:14Z",
    "model": "claude-3-5-haiku-20241022"
  }
]
```

**å½±å“è¯„ä¼°**ï¼š
- âœ… **å‘åå…¼å®¹**ï¼šåªæ–°å¢å­—æ®µï¼Œä¸åˆ é™¤åŸæœ‰å­—æ®µ
- âœ… **å‰ç«¯é€‚é…**ï¼šå‰ç«¯éœ€è¦å¤„ç†æ–°å­—æ®µï¼Œä½†æ—§é€»è¾‘ä»å¯ç”¨

---

## ğŸ’¾ æ•°æ®åº“/å­˜å‚¨å½±å“èŒƒå›´

### Redis æ•°æ®ç»“æ„å˜åŒ–

#### 1. æ¶ˆæ¯åˆ—è¡¨é”®ï¼š`chat:messages:<sessionId>`

**å½“å‰æ•°æ®**ï¼ˆListï¼‰ï¼š
```json
[
  "{\"role\":\"user\",\"content\":\"ä½ å¥½\",\"storedAt\":\"2025-10-08T18:09:14Z\"}"
]
```

**ä¼˜åŒ–åæ•°æ®**ï¼ˆListï¼‰ï¼š
```json
[
  "{\"role\":\"user\",\"subtype\":\"message\",\"messageGroupId\":\"group_123_req1_xxx\",\"isVisible\":true,\"content\":\"ä½ å¥½\",\"storedAt\":\"2025-10-08T18:09:14Z\"}"
]
```

**å½±å“è¯„ä¼°**ï¼š
- âœ… **å­˜å‚¨ç»“æ„ä¸å˜**ï¼šä»ä¸º Redis List
- âœ… **å­˜å‚¨å¼€é”€**ï¼šæ¯æ¡æ¶ˆæ¯å¢åŠ çº¦ 50-80 å­—èŠ‚
- âœ… **æŸ¥è¯¢æ€§èƒ½**ï¼šæ— å½±å“ï¼Œä»ä¸º O(1) æŸ¥è¯¢

---

#### 2. ä¼šè¯å…ƒæ•°æ®é”®ï¼š`chat:session:<sessionId>`

**æ— éœ€ä¿®æ”¹**ï¼Œå…ƒæ•°æ®ï¼ˆmessageCountã€totalTokens ç­‰ï¼‰é€»è¾‘ä¿æŒä¸å˜ã€‚

---

### æ•°æ®è¿ç§»æ–¹æ¡ˆ

#### ğŸ”„ å…¼å®¹æ€§ç­–ç•¥ï¼ˆæ¨èï¼‰

**æ–¹æ¡ˆ**ï¼šä¸åšæ•°æ®è¿ç§»ï¼Œä»£ç å±‚å¤„ç†å…¼å®¹æ€§

```javascript
// æŸ¥è¯¢æ—¶ä¸ºæ—§æ•°æ®è‡ªåŠ¨è¡¥å……é»˜è®¤å€¼
const normalizeMessage = (rawMessage) => {
  return {
    ...rawMessage,
    messageGroupId: rawMessage.messageGroupId || `legacy_${rawMessage.storedAt}`,
    subtype: rawMessage.subtype || 'message',
    isVisible: rawMessage.isVisible !== undefined ? rawMessage.isVisible : true
  }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ— éœ€è„šæœ¬è¿ç§»ï¼Œé›¶åœæœºæ—¶é—´
- âœ… æ—§æ•°æ®è‡ªåŠ¨é€‚é…ï¼Œæ— æ„Ÿå‡çº§
- âœ… å›æ»šé£é™©ä½

**ç¼ºç‚¹**ï¼š
- âš ï¸ æ—§æ•°æ®æ— æ³•äº«å—ç²¾ç¡®åˆ†ç»„ï¼ˆå½±å“æœ‰é™ï¼‰

---

#### ğŸ”§ æ‰¹é‡è¿ç§»æ–¹æ¡ˆï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ä¸ºå†å²æ•°æ®ç”Ÿæˆç²¾ç¡®çš„ `messageGroupId`ï¼š

```javascript
// scripts/migrate-message-groups.js
async function migrateHistoryData() {
  const sessions = await redis.keys('chat:messages:*')

  for (const sessionKey of sessions) {
    const messages = await redis.lrange(sessionKey, 0, -1)
    const updated = messages.map((msg, index) => {
      const parsed = JSON.parse(msg)
      if (!parsed.messageGroupId) {
        // æ ¹æ® requestId æˆ–æ—¶é—´çª—å£ç”Ÿæˆåˆ†ç»„
        parsed.messageGroupId = generateLegacyGroupId(parsed, index)
        parsed.subtype = parsed.subtype || 'message'
        parsed.isVisible = true
      }
      return JSON.stringify(parsed)
    })

    // æ›¿æ¢æ•´ä¸ªåˆ—è¡¨
    await redis.del(sessionKey)
    await redis.rpush(sessionKey, ...updated)
  }
}
```

**è¯„ä¼°**ï¼š
- âš ï¸ éœ€è¦è¯„ä¼°æ•°æ®é‡ï¼Œå¯èƒ½è€—æ—¶è¾ƒé•¿
- ğŸ”¢ **é¢„ä¼°**ï¼š10 ä¸‡æ¡æ¶ˆæ¯çº¦ 5-10 åˆ†é’Ÿ

---

## ğŸ¨ å‰ç«¯å½±å“èŒƒå›´

### 1. ç»„ä»¶ä¿®æ”¹

#### âœï¸ `src/views/HistoryView.vue`

**å½“å‰ç»“æ„**ï¼š
```vue
<div v-for="message in messages" :key="message.storedAt">
  <!-- å¹³é“ºå±•ç¤ºæ‰€æœ‰æ¶ˆæ¯ -->
  <div :class="message.role === 'assistant' ? 'ai' : 'user'">
    {{ message.content }}
  </div>
</div>
```

**ä¼˜åŒ–åç»“æ„**ï¼š
```vue
<div v-for="group in messageGroups" :key="group.id">
  <!-- æŒ‰ç»„æ¸²æŸ“ -->
  <MessageGroup :group="group" :displayMode="displayMode" />
</div>
```

**å½±å“è¯„ä¼°**ï¼š
- ğŸ”´ **é‡æ„èŒƒå›´å¤§**ï¼šéœ€è¦é‡å†™æ¶ˆæ¯æ¸²æŸ“é€»è¾‘
- ğŸ”¢ **ä»£ç å˜åŠ¨**ï¼šçº¦ 200-300 è¡Œ

---

#### ğŸ†• æ–°å¢ç»„ä»¶

1. **`MessageGroup.vue`** - æ¶ˆæ¯ç»„å®¹å™¨
   ```vue
   <template>
     <div class="message-group">
       <UserMessage v-if="group.userMessage" :message="group.userMessage" />
       <AssistantGroup v-if="group.assistantMessages" :messages="group.assistantMessages" />
       <SystemMessage v-if="showSystem && group.systemMessages" :messages="group.systemMessages" />
     </div>
   </template>
   ```
   - ğŸ”¢ **ä»£ç è¡Œæ•°**ï¼šçº¦ 100 è¡Œ

2. **`AssistantGroup.vue`** - AI å›å¤ç»„ï¼ˆå«æŠ˜å é€»è¾‘ï¼‰
   ```vue
   <template>
     <div class="assistant-group">
       <div v-if="thinkingMessages.length" class="thinking-section">
         <button @click="toggleThinking">
           ğŸ’­ AI æ€è€ƒè¿‡ç¨‹å·²æŠ˜å  <i :class="showThinking ? 'fa-chevron-up' : 'fa-chevron-down'" />
         </button>
         <div v-show="showThinking" class="thinking-content">
           <!-- æ¸²æŸ“æ€è€ƒè¿‡ç¨‹ -->
         </div>
       </div>
       <div class="final-response">
         {{ finalMessage.content }}
       </div>
     </div>
   </template>
   ```
   - ğŸ”¢ **ä»£ç è¡Œæ•°**ï¼šçº¦ 150 è¡Œ

3. **`SystemMessage.vue`** - ç³»ç»Ÿæ¶ˆæ¯
   - ğŸ”¢ **ä»£ç è¡Œæ•°**ï¼šçº¦ 50 è¡Œ

---

### 2. çŠ¶æ€ç®¡ç†

#### âœï¸ æ¶ˆæ¯åˆ†ç»„é€»è¾‘

```javascript
// åœ¨ HistoryView.vue ä¸­æ–°å¢è®¡ç®—å±æ€§
const messageGroups = computed(() => {
  const groups = new Map()

  messages.value.forEach(message => {
    const groupId = message.messageGroupId || `legacy_${message.storedAt}`

    if (!groups.has(groupId)) {
      groups.set(groupId, {
        id: groupId,
        userMessage: null,
        assistantMessages: [],
        systemMessages: []
      })
    }

    const group = groups.get(groupId)
    if (message.role === 'user') {
      group.userMessage = message
    } else if (message.role === 'assistant') {
      group.assistantMessages.push(message)
    } else if (message.role === 'system') {
      group.systemMessages.push(message)
    }
  })

  return Array.from(groups.values())
})

// æ–°å¢æ˜¾ç¤ºæ¨¡å¼çŠ¶æ€
const displayMode = ref('simple') // 'simple' | 'detailed' | 'debug'
const showSystemMessages = ref(false)
```

**å½±å“è¯„ä¼°**ï¼š
- ğŸ”¢ **æ–°å¢ä»£ç **ï¼šçº¦ 80 è¡Œ
- âœ… **æ€§èƒ½**ï¼šåˆ†ç»„ä¸ºçº¯å‰ç«¯è®¡ç®—ï¼Œä¸å½±å“è¯·æ±‚æ€§èƒ½

---

### 3. äº¤äº’åŠŸèƒ½

#### ğŸ†• æ–°å¢åŠŸèƒ½

1. **æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢**
   ```vue
   <div class="display-mode-toggle">
     <button @click="displayMode = 'simple'" :class="{ active: displayMode === 'simple' }">
       ç²¾ç®€æ¨¡å¼
     </button>
     <button @click="displayMode = 'detailed'" :class="{ active: displayMode === 'detailed' }">
       è¯¦ç»†æ¨¡å¼
     </button>
   </div>
   ```

2. **æ€è€ƒè¿‡ç¨‹æŠ˜å /å±•å¼€**
   ```javascript
   const expandedGroups = ref(new Set())

   const toggleThinking = (groupId) => {
     if (expandedGroups.value.has(groupId)) {
       expandedGroups.value.delete(groupId)
     } else {
       expandedGroups.value.add(groupId)
     }
   }
   ```

3. **ç³»ç»Ÿæ¶ˆæ¯æ˜¾ç¤ºå¼€å…³**
   ```vue
   <label>
     <input type="checkbox" v-model="showSystemMessages" />
     æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
   </label>
   ```

**å½±å“è¯„ä¼°**ï¼š
- ğŸ”¢ **ä»£ç è¡Œæ•°**ï¼šçº¦ 50 è¡Œ
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šæ˜¾è‘—æå‡å¯è¯»æ€§

---

## ğŸ”€ API è·¯ç”±å½±å“

### æ— éœ€ä¿®æ”¹

å½“å‰æ¥å£ `GET /api/history/sessions/:id/messages` å·²è¶³å¤Ÿï¼Œåªéœ€è¦åç«¯è¿”å›æ–°å­—æ®µã€‚

**å¯é€‰ä¼˜åŒ–**ï¼šæ–°å¢æŸ¥è¯¢å‚æ•°æ”¯æŒå‰ç«¯è¿‡æ»¤

```javascript
// src/routes/history.js
router.get('/sessions/:id/messages', async (req, res) => {
  const { sessionId } = req.params
  const { mode = 'all' } = req.query  // 'all' | 'visible' | 'debug'

  let messages = await historyService.getSessionMessages(sessionId)

  if (mode === 'visible') {
    messages = messages.filter(m => m.isVisible)
  }

  res.json(messages)
})
```

**å½±å“è¯„ä¼°**ï¼š
- ğŸ”¢ **ä»£ç è¡Œæ•°**ï¼š+10 è¡Œ
- âœ… **å¯é€‰å®ç°**ï¼šå¯åç»­ä¼˜åŒ–ï¼Œä¸å½±å“å½“å‰æ–¹æ¡ˆ

---

## ğŸ“‹ å·¥ä½œé‡ä¸é£é™©è¯„ä¼°

### å¼€å‘å·¥ä½œé‡

| ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|--------|
| **åç«¯ - æ¶ˆæ¯åˆ†ç±»é€»è¾‘** | 2-3 å°æ—¶ | ğŸ”´ é«˜ |
| **åç«¯ - åˆ†ç»„IDç”Ÿæˆ** | 1 å°æ—¶ | ğŸ”´ é«˜ |
| **åç«¯ - æ•°æ®å…¼å®¹å¤„ç†** | 1 å°æ—¶ | ğŸ”´ é«˜ |
| **å‰ç«¯ - ç»„ä»¶é‡æ„** | 4-5 å°æ—¶ | ğŸ”´ é«˜ |
| **å‰ç«¯ - äº¤äº’é€»è¾‘** | 2 å°æ—¶ | ğŸŸ¡ ä¸­ |
| **æµ‹è¯• - å•å…ƒæµ‹è¯•** | 2 å°æ—¶ | ğŸŸ¡ ä¸­ |
| **æµ‹è¯• - é›†æˆæµ‹è¯•** | 1 å°æ—¶ | ğŸŸ¡ ä¸­ |
| **æ–‡æ¡£ - ä½¿ç”¨è¯´æ˜** | 1 å°æ—¶ | ğŸŸ¢ ä½ |
| **æ€»è®¡** | **14-16 å°æ—¶** | - |

---

### é£é™©è¯„ä¼°

| é£é™©é¡¹ | é£é™©ç­‰çº§ | å½±å“ | ç¼“è§£æªæ–½ |
|--------|---------|------|---------|
| **æ¶ˆæ¯åˆ†ç±»è§„åˆ™ä¸å‡†ç¡®** | ğŸŸ¡ ä¸­ | éƒ¨åˆ†æ¶ˆæ¯å¯èƒ½é”™è¯¯åˆ†ç±» | æä¾›"æ‰‹åŠ¨è°ƒæ•´"åŠŸèƒ½ |
| **å‰ç«¯é‡æ„å¼•å…¥ Bug** | ğŸŸ¡ ä¸­ | å¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½ | å……åˆ†æµ‹è¯•ï¼Œç°åº¦å‘å¸ƒ |
| **æ—§æ•°æ®æ˜¾ç¤ºå¼‚å¸¸** | ğŸŸ¢ ä½ | æ—§ä¼šè¯ç¼ºå°‘åˆ†ç»„ä¿¡æ¯ | ä»£ç å±‚å…¼å®¹å¤„ç† |
| **æ€§èƒ½é—®é¢˜** | ğŸŸ¢ ä½ | å‰ç«¯åˆ†ç»„è®¡ç®—è€—æ—¶ | ä½¿ç”¨ computed ç¼“å­˜ |
| **ç”¨æˆ·å­¦ä¹ æˆæœ¬** | ğŸŸ¢ ä½ | æ–° UI éœ€è¦é€‚åº” | æä¾›"é¦–æ¬¡å¼•å¯¼" |

---

### å›æ»šæ–¹æ¡ˆ

**å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯å¿«é€Ÿå›æ»š**ï¼š

1. **åç«¯å›æ»š**ï¼š
   ```bash
   git revert <commit-hash>  # å›é€€ä»£ç 
   # æ—§æ•°æ®è‡ªåŠ¨å…¼å®¹ï¼Œæ— éœ€æ¢å¤
   ```

2. **å‰ç«¯å›æ»š**ï¼š
   ```bash
   git revert <commit-hash>  # å›é€€ UI
   # æˆ–é€šè¿‡ feature flag åˆ‡æ¢
   ```

3. **æ•°æ®åº“**ï¼š
   - âœ… æ— éœ€å›æ»šï¼ˆåªæ–°å¢å­—æ®µï¼Œä¸åˆ é™¤ï¼‰

---

## âœ… æ€»ç»“

### æ ¸å¿ƒå½±å“

| å±‚çº§ | ä¸»è¦å˜æ›´ | å…³é”®æ–‡ä»¶ |
|------|---------|---------|
| **åç«¯** | æ¶ˆæ¯åˆ†ç±»é€»è¾‘ + åˆ†ç»„IDç”Ÿæˆ | `historyService.js`, `sessionStore.js` |
| **å­˜å‚¨** | æ–°å¢å­—æ®µï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰ | Redis `chat:messages:*` |
| **å‰ç«¯** | æ¶ˆæ¯åˆ†ç»„æ¸²æŸ“ + æŠ˜å äº¤äº’ | `HistoryView.vue` + 3ä¸ªæ–°ç»„ä»¶ |
| **API** | è¿”å›æ•°æ®å¢åŠ å­—æ®µ | `/api/history/sessions/:id/messages` |

### å®æ–½å»ºè®®

1. **é˜¶æ®µ 1ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰**ï¼š
   - âœ… åç«¯æ¶ˆæ¯åˆ†ç±»ä¸åˆ†ç»„
   - âœ… å‰ç«¯åŸºç¡€åˆ†ç»„æ¸²æŸ“

2. **é˜¶æ®µ 2ï¼ˆä½“éªŒä¼˜åŒ–ï¼‰**ï¼š
   - âœ… æ€è€ƒè¿‡ç¨‹æŠ˜å /å±•å¼€
   - âœ… æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢

3. **é˜¶æ®µ 3ï¼ˆé”¦ä¸Šæ·»èŠ±ï¼‰**ï¼š
   - âœ… ç³»ç»Ÿæ¶ˆæ¯é«˜çº§è¿‡æ»¤
   - âœ… æœç´¢é«˜äº®ã€å¯¼å‡ºåŠŸèƒ½

### é£é™©æ§åˆ¶

- âœ… **å‘åå…¼å®¹**ï¼šæ—§æ•°æ®è‡ªåŠ¨é€‚é…
- âœ… **å¢é‡å‘å¸ƒ**ï¼šå¯ç°åº¦æµ‹è¯•
- âœ… **å¿«é€Ÿå›æ»š**ï¼šGit revert å³å¯
- âœ… **æ€§èƒ½æ— å¿§**ï¼šæ— é¢å¤–æŸ¥è¯¢å¼€é”€

---

**é¢„è®¡æ€»å·¥æ—¶ï¼š14-16 å°æ—¶**
**å»ºè®®åˆ† 2-3 å¤©å®Œæˆï¼Œé€æ­¥å‘å¸ƒ**
