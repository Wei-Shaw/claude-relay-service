# Claude Relay Service è¯·æ±‚å¤„ç†å®Œæ•´æµç¨‹å›¾

> ç‰ˆæœ¬: 1.1.0 | æ›´æ–°æ—¥æœŸ: 2025-12-07
>
> æ–°å¢ä¸Šæ¸¸ 5xx è‡ªåŠ¨æ•…éšœè½¬ç§»æœºåˆ¶

## æµç¨‹æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Claude Relay Service è¯·æ±‚å¤„ç†æµç¨‹                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Phase 1: è·¯ç”±åŒ¹é… â†’ Phase 2: ä¸­é—´ä»¶éªŒè¯ â†’ Phase 3: è¯·æ±‚éªŒè¯ â†’                    â”‚
â”‚  Phase 4: è´¦æˆ·è°ƒåº¦ â†’ Phase 5: è¯·æ±‚è½¬å‘ â†’ Phase 6: å“åº”å¤„ç†                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 0: è¯·æ±‚è¿›å…¥ (Pre-Auth)

```
å®¢æˆ·ç«¯è¯·æ±‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  0ï¸âƒ£ CORS é¢„æ£€å¤„ç†                        â”‚
â”‚  â”œâ”€ OPTIONS è¯·æ±‚ â†’ è¿”å› CORS headers      â”‚
â”‚  â””â”€ å…¶ä»–è¯·æ±‚ â†’ ç»§ç»­                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  0ï¸âƒ£ è¯·æ±‚ä½“å¤§å°æ£€æŸ¥                        â”‚
â”‚  â”œâ”€ Content-Length > 60MB               â”‚
â”‚  â”‚   âŒ 413 Request Entity Too Large     â”‚
â”‚  â”‚   "Request body too large, limit: 10MB" â”‚
â”‚  â””â”€ â‰¤60MB â†’ ç»§ç»­                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
  Phase 1
```

---

## Phase 1: è·¯ç”±åŒ¹é…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         è·¯ç”±åˆ†å‘                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /api/v1/messages          â†’ Claude å®˜æ–¹ API è·¯ç”±               â”‚
â”‚  /claude/v1/messages       â†’ Claude å®˜æ–¹ API è·¯ç”± (åˆ«å)         â”‚
â”‚  /v1/messages/count_tokens â†’ Token è®¡æ•°è·¯ç”± âš ï¸ (è·³è¿‡éƒ¨åˆ†é™åˆ¶)    â”‚
â”‚  /gemini/v1/...            â†’ Gemini API è·¯ç”±                    â”‚
â”‚  /openai/v1/...            â†’ OpenAI å…¼å®¹è·¯ç”±                    â”‚
â”‚  /openai/responses         â†’ OpenAI Responses (Codex) è·¯ç”±      â”‚
â”‚  /droid/...                â†’ Droid (Factory.ai) è·¯ç”±            â”‚
â”‚  /azure/...                â†’ Azure OpenAI è·¯ç”±                  â”‚
â”‚  /admin/...                â†’ ç®¡ç†åå°è·¯ç”±                        â”‚
â”‚  /health                   â†’ å¥åº·æ£€æŸ¥ (æ— éœ€è®¤è¯)                  â”‚
â”‚  /metrics                  â†’ ç³»ç»ŸæŒ‡æ ‡ (æ— éœ€è®¤è¯)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 2: ä¸­é—´ä»¶é“¾å¤„ç† (auth.js)

### æ ‡å‡†è·¯ç”±å¤„ç†æµç¨‹

```
è¯·æ±‚åˆ°è¾¾ authenticateApiKey ä¸­é—´ä»¶
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£ extractApiKey()                     â”‚
â”‚  ä»å¤šä¸ªä½ç½®æå– API Key:                  â”‚
â”‚  â”œâ”€ x-api-key header                    â”‚
â”‚  â”œâ”€ x-goog-api-key header (Gemini CLI)  â”‚
â”‚  â”œâ”€ Authorization: Bearer <key>         â”‚
â”‚  â”œâ”€ api-key header                      â”‚
â”‚  â””â”€ ?key= query parameter               â”‚
â”‚                                         â”‚
â”‚  âŒ ç¼ºå¤±: 401 Unauthorized               â”‚
â”‚     "Please provide an API key..."      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… æå–æˆåŠŸ
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£ åŸºç¡€æ ¼å¼éªŒè¯                         â”‚
â”‚  â”œâ”€ é•¿åº¦æ£€æŸ¥: 10-512 å­—ç¬¦                 â”‚
â”‚                                         â”‚
â”‚  âŒ æ ¼å¼æ— æ•ˆ: 401 Unauthorized            â”‚
â”‚     "API key format is invalid"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… æ ¼å¼æ­£ç¡®
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£ apiKeyService.validateApiKey()      â”‚
â”‚  â”œâ”€ SHA-256 å“ˆå¸ŒæŸ¥è¯¢ Redis               â”‚
â”‚  â”œâ”€ æ£€æŸ¥ Key æ˜¯å¦å­˜åœ¨                     â”‚
â”‚  â”œâ”€ æ£€æŸ¥ Key æ˜¯å¦è¢«ç¦ç”¨                   â”‚
â”‚  â”œâ”€ æ£€æŸ¥ Key æ˜¯å¦è¿‡æœŸ                     â”‚
â”‚                                         â”‚
â”‚  âŒ æ— æ•ˆ: 401 Unauthorized               â”‚
â”‚     "Invalid API key" + å…·ä½“åŸå›          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… Key æœ‰æ•ˆ
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ï¸âƒ£ å®¢æˆ·ç«¯é™åˆ¶æ£€æŸ¥ (ClientValidator)     â”‚
â”‚  âš ï¸ count_tokens è·¯ç”±è·³è¿‡æ­¤æ£€æŸ¥           â”‚
â”‚                                         â”‚
â”‚  æ£€æŸ¥æ¡ä»¶:                               â”‚
â”‚  â”œâ”€ enableClientRestriction = true      â”‚
â”‚  â””â”€ allowedClients æ•°ç»„é…ç½®              â”‚
â”‚                                         â”‚
â”‚  éªŒè¯ User-Agent æ˜¯å¦åŒ¹é…å…è®¸çš„å®¢æˆ·ç«¯:     â”‚
â”‚  â”œâ”€ ClaudeCode                          â”‚
â”‚  â”œâ”€ Gemini-CLI                          â”‚
â”‚  â”œâ”€ Codex-CLI                           â”‚
â”‚  â””â”€ è‡ªå®šä¹‰å®¢æˆ·ç«¯                         â”‚
â”‚                                         â”‚
â”‚  âŒ ä¸åŒ¹é…: 403 Forbidden                â”‚
â”‚     "Your client is not authorized..."  â”‚
â”‚     Response: { allowedClients, userAgent } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… å®¢æˆ·ç«¯å…è®¸
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5ï¸âƒ£ å¹¶å‘é™åˆ¶æ£€æŸ¥                         â”‚
â”‚  âš ï¸ count_tokens è·¯ç”±è·³è¿‡æ­¤æ£€æŸ¥           â”‚
â”‚                                         â”‚
â”‚  æ£€æŸ¥æ¡ä»¶: concurrencyLimit > 0          â”‚
â”‚  å®ç°: Redis Sorted Set                  â”‚
â”‚  Key: concurrency:{apiKeyId}            â”‚
â”‚                                         â”‚
â”‚  æœºåˆ¶:                                   â”‚
â”‚  â”œâ”€ è·å–å½“å‰å¹¶å‘æ•°                        â”‚
â”‚  â”œâ”€ æ£€æŸ¥æ˜¯å¦è¶…é™                          â”‚
â”‚  â”œâ”€ æ³¨å†Œè¯·æ±‚ (requestId + timestamp)     â”‚
â”‚  â””â”€ è®¾ç½®æ¸…ç†å›è°ƒ (res.close/finish)       â”‚
â”‚                                         â”‚
â”‚  âŒ è¶…é™: 429 Too Many Requests          â”‚
â”‚     "Too many concurrent requests"      â”‚
â”‚     Response: { currentConcurrency,     â”‚
â”‚                 concurrencyLimit }      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… å¹¶å‘å…è®¸
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6ï¸âƒ£ é€Ÿç‡é™åˆ¶æ£€æŸ¥ (æ—¶é—´çª—å£å†…)             â”‚
â”‚  âš ï¸ count_tokens è·¯ç”±è·³è¿‡æ­¤æ£€æŸ¥           â”‚
â”‚                                         â”‚
â”‚  çª—å£é…ç½®: rateLimitWindow (åˆ†é’Ÿ)         â”‚
â”‚                                         â”‚
â”‚  6a. è¯·æ±‚è®¡æ•°é™åˆ¶ (rateLimitRequests)    â”‚
â”‚      âŒ 429 "å·²è¾¾åˆ°è¯·æ±‚æ¬¡æ•°é™åˆ¶ (Næ¬¡)"     â”‚
â”‚                                         â”‚
â”‚  6b. Token é™åˆ¶ (tokenLimit) - æ—§æ ¼å¼    â”‚
â”‚      âŒ 429 "å·²è¾¾åˆ° Token ä½¿ç”¨é™åˆ¶"       â”‚
â”‚                                         â”‚
â”‚  6c. è´¹ç”¨é™åˆ¶ (rateLimitCost) - æ–°æ ¼å¼   â”‚
â”‚      âŒ 429 "å·²è¾¾åˆ°è´¹ç”¨é™åˆ¶ ($X)"         â”‚
â”‚                                         â”‚
â”‚  Response: { resetAt, currentUsage }    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… æœªè§¦å‘é™åˆ¶
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7ï¸âƒ£ æ¯æ—¥è´¹ç”¨é™åˆ¶æ£€æŸ¥                      â”‚
â”‚  âš ï¸ count_tokens è·¯ç”±è·³è¿‡æ­¤æ£€æŸ¥           â”‚
â”‚                                         â”‚
â”‚  æ£€æŸ¥æ¡ä»¶: dailyCostLimit > 0            â”‚
â”‚  æ¯”è¾ƒ: dailyCost vs dailyCostLimit      â”‚
â”‚                                         â”‚
â”‚  âŒ è¶…é™: 429 Too Many Requests          â”‚
â”‚     "å·²è¾¾åˆ°æ¯æ—¥è´¹ç”¨é™åˆ¶ ($X)"             â”‚
â”‚     Response: { resetAt: æ˜å¤©0ç‚¹ }       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… æ¯æ—¥é™é¢æœªè¶…
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8ï¸âƒ£ æ€»è´¹ç”¨é™åˆ¶æ£€æŸ¥                        â”‚
â”‚  âš ï¸ count_tokens è·¯ç”±è·³è¿‡æ­¤æ£€æŸ¥           â”‚
â”‚                                         â”‚
â”‚  æ£€æŸ¥æ¡ä»¶: totalCostLimit > 0            â”‚
â”‚  æ¯”è¾ƒ: totalCost vs totalCostLimit      â”‚
â”‚                                         â”‚
â”‚  âŒ è¶…é™: 429 Too Many Requests          â”‚
â”‚     "å·²è¾¾åˆ°æ€»è´¹ç”¨é™åˆ¶ ($X)"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… æ€»é™é¢æœªè¶…
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9ï¸âƒ£ Opus å‘¨è´¹ç”¨é™åˆ¶æ£€æŸ¥                   â”‚
â”‚  âš ï¸ count_tokens è·¯ç”±è·³è¿‡æ­¤æ£€æŸ¥           â”‚
â”‚                                         â”‚
â”‚  æ£€æŸ¥æ¡ä»¶:                               â”‚
â”‚  â”œâ”€ weeklyOpusCostLimit > 0             â”‚
â”‚  â””â”€ è¯·æ±‚æ¨¡å‹åŒ…å« "claude-opus"           â”‚
â”‚                                         â”‚
â”‚  å‘¨æœŸ: æ¯å‘¨ä¸€ 00:00 é‡ç½®                  â”‚
â”‚                                         â”‚
â”‚  âŒ è¶…é™: 429 Too Many Requests          â”‚
â”‚     "å·²è¾¾åˆ° Opus æ¨¡å‹å‘¨è´¹ç”¨é™åˆ¶ ($X)"     â”‚
â”‚     Response: { resetAt: ä¸‹å‘¨ä¸€ }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… æ‰€æœ‰éªŒè¯é€šè¿‡
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… è®¤è¯æˆåŠŸ                              â”‚
â”‚                                         â”‚
â”‚  å­˜å‚¨åˆ°è¯·æ±‚å¯¹è±¡:                          â”‚
â”‚  â”œâ”€ req.apiKey = { id, name, limits... }â”‚
â”‚  â”œâ”€ req.rateLimitInfo = { ... }         â”‚
â”‚  â””â”€ req.concurrencyInfo = { ... }       â”‚
â”‚                                         â”‚
â”‚  è°ƒç”¨ next() â†’ Phase 3                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 3: è¯·æ±‚ä½“éªŒè¯å’Œæƒé™æ£€æŸ¥ (api.js)

```
handleMessagesRequest()
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£ æœåŠ¡æƒé™æ£€æŸ¥                         â”‚
â”‚                                         â”‚
â”‚  æ£€æŸ¥ req.apiKey.permissions:            â”‚
â”‚  â”œâ”€ 'all'    â†’ å…è®¸æ‰€æœ‰æœåŠ¡              â”‚
â”‚  â”œâ”€ 'claude' â†’ ä»… Claude æœåŠ¡            â”‚
â”‚  â”œâ”€ 'gemini' â†’ ä»… Gemini æœåŠ¡            â”‚
â”‚  â””â”€ 'openai' â†’ ä»… OpenAI æœåŠ¡            â”‚
â”‚                                         â”‚
â”‚  âŒ æ— æƒé™: 403 Forbidden                â”‚
â”‚     "æ­¤ API Key æ— æƒè®¿é—® Claude æœåŠ¡"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… æœ‰æƒé™
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£ è¯·æ±‚ä½“éªŒè¯                           â”‚
â”‚                                         â”‚
â”‚  éªŒè¯é¡¹:                                 â”‚
â”‚  â”œâ”€ req.body å¿…é¡»æ˜¯å¯¹è±¡                   â”‚
â”‚  â”œâ”€ req.body.messages å¿…é¡»æ˜¯æ•°ç»„          â”‚
â”‚  â””â”€ messages ä¸èƒ½ä¸ºç©º                     â”‚
â”‚                                         â”‚
â”‚  âŒ æ— æ•ˆ: 400 Bad Request                â”‚
â”‚     å…·ä½“çš„éªŒè¯é”™è¯¯æ¶ˆæ¯                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… è¯·æ±‚ä½“æœ‰æ•ˆ
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£ æ¨¡å‹é»‘åå•æ£€æŸ¥                        â”‚
â”‚                                         â”‚
â”‚  æ£€æŸ¥æ¡ä»¶:                               â”‚
â”‚  â”œâ”€ enableModelRestriction = true       â”‚
â”‚  â””â”€ restrictedModels æ•°ç»„æœ‰å€¼            â”‚
â”‚                                         â”‚
â”‚  æµç¨‹:                                   â”‚
â”‚  â”œâ”€ ä» body.model è·å–æ¨¡å‹å              â”‚
â”‚  â”œâ”€ getEffectiveModel() å»é™¤ä¾›åº”å•†å‰ç¼€    â”‚
â”‚  â””â”€ æ£€æŸ¥æ˜¯å¦åœ¨ restrictedModels ä¸­        â”‚
â”‚                                         â”‚
â”‚  âŒ å—é™: 403 Forbidden                  â”‚
â”‚     "æš‚æ— è¯¥æ¨¡å‹è®¿é—®æƒé™"                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… æ¨¡å‹å…è®¸
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ï¸âƒ£ Claude Code å®¢æˆ·ç«¯æ£€æµ‹               â”‚
â”‚  (ä»… Claude æœåŠ¡)                        â”‚
â”‚                                         â”‚
â”‚  æ£€æµ‹ User-Agent æ˜¯å¦ä¸º Claude Code:      â”‚
â”‚  â”œâ”€ æ˜¯ â†’ æ³¨å…¥ç‰¹æ®Š headers                â”‚
â”‚  â”‚   â”œâ”€ claude-code-20250219            â”‚
â”‚  â”‚   â””â”€ System Prompt æ³¨å…¥               â”‚
â”‚  â””â”€ å¦ â†’ ä½¿ç”¨æ ‡å‡†å¤„ç†                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
  Phase 4: è´¦æˆ·è°ƒåº¦
```

---

## Phase 4: ç»Ÿä¸€è°ƒåº¦å™¨ (unifiedClaudeScheduler.js)

```
selectAccountForApiKey(apiKeyData, sessionHash, requestedModel)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£ ä¾›åº”å•†å‰ç¼€è§£æ                        â”‚
â”‚                                         â”‚
â”‚  parseVendorPrefixedModel(requestedModel)â”‚
â”‚  â”œâ”€ ccr:model-name â†’ CCR è´¦æˆ·æ±           â”‚
â”‚  â”œâ”€ vendor:model-name â†’ ç‰¹å®šä¾›åº”å•†        â”‚
â”‚  â””â”€ model-name â†’ é»˜è®¤è´¦æˆ·æ±                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£ CCR/ç‰¹å®šä¾›åº”å•†å¤„ç†                    â”‚
â”‚                                         â”‚
â”‚  å¦‚æœæ£€æµ‹åˆ° ccr: å‰ç¼€:                    â”‚
â”‚  â””â”€ è°ƒç”¨ _selectCcrAccount()             â”‚
â”‚     â”œâ”€ ä» CCR è´¦æˆ·æ± é€‰æ‹©                  â”‚
â”‚     â””â”€ æ£€æŸ¥æ¨¡å‹æ”¯æŒæ€§                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£ ä¸“å±è´¦æˆ·/åˆ†ç»„ç»‘å®šæ£€æŸ¥                  â”‚
â”‚                                         â”‚
â”‚  æ£€æŸ¥ apiKeyData.claudeAccountId:        â”‚
â”‚                                         â”‚
â”‚  3a. åˆ†ç»„ç»‘å®š (group:xxx)                â”‚
â”‚      â””â”€ selectAccountFromGroup()        â”‚
â”‚                                         â”‚
â”‚  3b. å•ä¸€è´¦æˆ·ç»‘å®š (ä¸“å±è´¦æˆ·)              â”‚
â”‚      æ£€æŸ¥é¡¹:                             â”‚
â”‚      â”œâ”€ isActive === 'true'             â”‚
â”‚      â”œâ”€ status !== 'error'              â”‚
â”‚      â”œâ”€ isAccountTemporarilyUnavailable()â”‚
â”‚      â””â”€ isAccountRateLimited()          â”‚
â”‚                                         â”‚
â”‚  âŒ ä¸“å±è´¦æˆ·é™æµ: 403 Forbidden           â”‚
â”‚     é”™è¯¯ç : CLAUDE_DEDICATED_RATE_LIMITED â”‚
â”‚     "æ­¤ä¸“å±è´¦å·å·²è§¦å‘é™æµæ§åˆ¶"             â”‚
â”‚     Response: { rateLimitEndAt }         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… æœ‰å¯ç”¨ä¸“å±è´¦æˆ· æˆ– ä½¿ç”¨é€šç”¨æ± 
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ï¸âƒ£ ç²˜æ€§ä¼šè¯æ£€æŸ¥                          â”‚
â”‚                                         â”‚
â”‚  Redis Key: unified_claude_session_     â”‚
â”‚             mapping:{sessionHash}       â”‚
â”‚                                         â”‚
â”‚  â”œâ”€ å­˜åœ¨ä¸”è´¦æˆ·å¯ç”¨ â†’ ä½¿ç”¨ç»‘å®šè´¦æˆ·          â”‚
â”‚  â”œâ”€ å­˜åœ¨ä½†è´¦æˆ·ä¸å¯ç”¨ â†’ æ¸…é™¤ç»‘å®š           â”‚
â”‚  â””â”€ ä¸å­˜åœ¨ â†’ è¿›å…¥é€šç”¨æ± é€‰æ‹©               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5ï¸âƒ£ é€šç”¨è´¦æˆ·æ± è¿‡æ»¤                        â”‚
â”‚                                         â”‚
â”‚  è·å–æ‰€æœ‰è´¦æˆ·ç±»å‹:                        â”‚
â”‚  â”œâ”€ claude-official (OAuth)             â”‚
â”‚  â”œâ”€ claude-console                      â”‚
â”‚  â”œâ”€ bedrock                             â”‚
â”‚  â””â”€ ccr                                 â”‚
â”‚                                         â”‚
â”‚  è¿‡æ»¤æ¡ä»¶:                               â”‚
â”‚  â”œâ”€ isActive === 'true'                 â”‚
â”‚  â”œâ”€ status !== 'error'/'unauthorized'/  â”‚
â”‚  â”‚          'blocked'                   â”‚
â”‚  â”œâ”€ schedulable === true                â”‚
â”‚  â”œâ”€ æœªè¢«ä¸´æ—¶æ ‡è®°ä¸å¯ç”¨                    â”‚
â”‚  â”œâ”€ æœªè¢«è¿‡è½½æ ‡è®°                          â”‚
â”‚  â””â”€ æ”¯æŒè¯·æ±‚çš„æ¨¡å‹                        â”‚
â”‚                                         â”‚
â”‚  âš ï¸ Console è´¦æˆ·å¹¶å‘é¢„æ£€æŸ¥                â”‚
â”‚     (æ‰¹é‡æ£€æŸ¥ maxConcurrentTasks)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6ï¸âƒ£ æ¨¡å‹æ”¯æŒæ€§æ£€æŸ¥                        â”‚
â”‚                                         â”‚
â”‚  Claude Official:                        â”‚
â”‚  â”œâ”€ åªæ”¯æŒ Claude æ¨¡å‹                    â”‚
â”‚  â””â”€ Opus è®¢é˜…çº§åˆ«é™åˆ¶:                    â”‚
â”‚      â”œâ”€ Free: æ—  Opus                    â”‚
â”‚      â”œâ”€ Pro: ä»… Opus 4.5+                â”‚
â”‚      â””â”€ Max: æ‰€æœ‰ Opus                   â”‚
â”‚                                         â”‚
â”‚  Claude Console:                         â”‚
â”‚  â””â”€ æ£€æŸ¥ supportedModels é…ç½®             â”‚
â”‚                                         â”‚
â”‚  CCR:                                    â”‚
â”‚  â””â”€ æ£€æŸ¥ supportedModels é…ç½®             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7ï¸âƒ£ æ’åºä¸é€‰æ‹©                            â”‚
â”‚                                         â”‚
â”‚  æ’åºä¼˜å…ˆçº§:                              â”‚
â”‚  â”œâ”€ 1. è´¦æˆ·ä¼˜å…ˆçº§ (priority)             â”‚
â”‚  â”œâ”€ 2. æœ€åä½¿ç”¨æ—¶é—´ (lastUsedAt)          â”‚
â”‚  â””â”€ 3. è´Ÿè½½å‡è¡¡è€ƒè™‘                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8ï¸âƒ£ ç²˜æ€§ä¼šè¯è®°å½•                          â”‚
â”‚                                         â”‚
â”‚  å¦‚æœé€‰ä¸­æ–°è´¦æˆ·:                          â”‚
â”‚  â”œâ”€ è®°å½• sessionHash â†’ accountId æ˜ å°„    â”‚
â”‚  â””â”€ TTL: STICKY_SESSION_TTL_HOURS (é»˜è®¤1h)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ æ— å¯ç”¨è´¦æˆ·                            â”‚
â”‚                                         â”‚
â”‚  æƒ…å†µ1: Console å¹¶å‘æ»¡                   â”‚
â”‚  â””â”€ 503 Service Unavailable             â”‚
â”‚     é”™è¯¯ç : CONSOLE_ACCOUNT_CONCURRENCY_FULL â”‚
â”‚     âš ï¸ ä¼šè§¦å‘ api.js å±‚çš„é‡è¯•é€»è¾‘          â”‚
â”‚                                         â”‚
â”‚  æƒ…å†µ2: æ— æ”¯æŒè¯¥æ¨¡å‹çš„è´¦æˆ·                 â”‚
â”‚  â””â”€ 500 Internal Server Error           â”‚
â”‚     (æŠ›å‡º Errorï¼Œæœªè¢«æ•è·ä¸º 503)          â”‚
â”‚                                         â”‚
â”‚  âœ… æˆåŠŸ                                 â”‚
â”‚  â””â”€ è¿”å› { accountId, accountType }      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 5: è¯·æ±‚è½¬å‘ (claudeRelayService.js)

```
relayRequest() / relayStreamRequestWithUsageCapture()
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£ è·å–è´¦æˆ·å®Œæ•´ä¿¡æ¯å¹¶è§£å¯†                 â”‚
â”‚                                         â”‚
â”‚  claudeAccountService.getAccount(id)     â”‚
â”‚  â”œâ”€ è§£å¯† OAuth token                     â”‚
â”‚  â””â”€ è§£å¯†æ•æ„Ÿé…ç½®                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£ Access Token è·å–/åˆ·æ–°               â”‚
â”‚  âš ï¸ OAuth åˆ·æ–°åœ¨æ­¤é˜¶æ®µæ‰§è¡Œ                 â”‚
â”‚                                         â”‚
â”‚  getValidAccessToken(accountId):          â”‚
â”‚  â”œâ”€ æ£€æŸ¥ token è¿‡æœŸæ—¶é—´                   â”‚
â”‚  â”œâ”€ æå‰ 10 ç§’åˆ·æ–°                        â”‚
â”‚  â””â”€ è°ƒç”¨ OAuth refresh endpoint          â”‚
â”‚                                         â”‚
â”‚  âŒ åˆ·æ–°å¤±è´¥: 500 Internal Server Error   â”‚
â”‚     (Token refresh failed)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ âœ… Token æœ‰æ•ˆ
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£ è¯·æ±‚å¤´æ„å»º                            â”‚
â”‚                                         â”‚
â”‚  filterForClaude() æ¸…ç†è¯·æ±‚å¤´:            â”‚
â”‚  â”œâ”€ ç§»é™¤ CDN/ä»£ç†ç›¸å…³ headers             â”‚
â”‚  â”œâ”€ ç§»é™¤å®¢æˆ·ç«¯ API Key                    â”‚
â”‚  â””â”€ æ·»åŠ è´¦æˆ·å‡­æ®                          â”‚
â”‚                                         â”‚
â”‚  æ·»åŠ çš„ Headers:                          â”‚
â”‚  â”œâ”€ Authorization: Bearer {accessToken}  â”‚
â”‚  â”œâ”€ anthropic-version: 2023-06-01       â”‚
â”‚  â””â”€ anthropic-beta: oauth-2025-04-20,   â”‚
â”‚     claude-code-20250219 (éHaiku),      â”‚
â”‚     interleaved-thinking-2025-05-14,     â”‚
â”‚     fine-grained-tool-streaming-2025-05-14â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ï¸âƒ£ ä»£ç†é…ç½®                              â”‚
â”‚                                         â”‚
â”‚  å¦‚æœè´¦æˆ·é…ç½®äº†ä»£ç†:                       â”‚
â”‚  â”œâ”€ ProxyHelper.createProxyAgent()       â”‚
â”‚  â””â”€ æ”¯æŒ SOCKS5 / HTTP ä»£ç†              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5ï¸âƒ£ å‘é€ä¸Šæ¸¸è¯·æ±‚                          â”‚
â”‚                                         â”‚
â”‚  Target: https://api.anthropic.com/     â”‚
â”‚          v1/messages                    â”‚
â”‚                                         â”‚
â”‚  é…ç½®:                                   â”‚
â”‚  â”œâ”€ Timeout: REQUEST_TIMEOUT (é»˜è®¤600s) â”‚
â”‚  â”œâ”€ socket.setNoDelay(true)             â”‚
â”‚  â””â”€ AbortController ç”¨äºå–æ¶ˆ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6ï¸âƒ£ ä¸Šæ¸¸å“åº”çŠ¶æ€ç å¤„ç†                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ çŠ¶æ€ç   â”‚ å¤„ç†é€»è¾‘                                        â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 200/201 â”‚ âœ… æˆåŠŸ â†’ Phase 6                              â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 400     â”‚ æ£€æŸ¥æ˜¯å¦ "Organization disabled"               â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ æ˜¯ â†’ æ ‡è®°è´¦æˆ· blocked                       â”‚  â”‚
â”‚  â”‚         â”‚ â””â”€ å¦ â†’ ç›´æ¥è¿”å›é”™è¯¯ç»™å®¢æˆ·ç«¯                    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 401     â”‚ ğŸ” Unauthorized                                â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ è®°å½• 401 é”™è¯¯è®¡æ•° (Redis)                   â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ è®¡æ•° > 1 â†’ æ ‡è®°è´¦æˆ· unauthorized            â”‚  â”‚
â”‚  â”‚         â”‚ â””â”€ è¿”å› 401 ç»™å®¢æˆ·ç«¯                           â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 403     â”‚ ğŸš« Forbidden                                   â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ æ ‡è®°è´¦æˆ· blocked                            â”‚  â”‚
â”‚  â”‚         â”‚ â””â”€ è¿”å› 403 ç»™å®¢æˆ·ç«¯                           â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 429     â”‚ ğŸš¦ Rate Limited                                â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ markAccountRateLimited()                    â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ æå– reset æ—¶é—´                             â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ ä¸“å±è´¦æˆ·/Opusé™åˆ¶ â†’ è¿”å› 403                 â”‚  â”‚
â”‚  â”‚         â”‚ â”‚   é”™è¯¯ç : upstream_rate_limited              â”‚  â”‚
â”‚  â”‚         â”‚ â”‚   é”™è¯¯ç : opus_weekly_limit                  â”‚  â”‚
â”‚  â”‚         â”‚ â””â”€ å…¶ä»–æƒ…å†µ â†’ è¿”å› 429                          â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 502     â”‚ ğŸ”Œ Bad Gateway                                 â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ è®°å½•æœåŠ¡å™¨é”™è¯¯                               â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ markAccountTemporarilyUnavailable()         â”‚  â”‚
â”‚  â”‚         â”‚ â””â”€ ğŸ”„ è§¦å‘ Failover è‡ªåŠ¨é‡è¯•               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 504     â”‚ â±ï¸ Gateway Timeout                             â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ è®°å½•è¶…æ—¶é”™è¯¯                                 â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ markAccountTemporarilyUnavailable()         â”‚  â”‚
â”‚  â”‚         â”‚ â””â”€ ğŸ”„ è§¦å‘ Failover è‡ªåŠ¨é‡è¯•               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 529     â”‚ ğŸ”¥ Over Capacity (Claude ç‰¹æœ‰)                 â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ markAccountOverloaded()                     â”‚  â”‚
â”‚  â”‚         â”‚ â”‚   Redis Key: overload:{accountId}            â”‚  â”‚
â”‚  â”‚         â”‚ â”‚   TTL: CLAUDE_OVERLOAD_HANDLING_MINUTES      â”‚  â”‚
â”‚  â”‚         â”‚ â””â”€ ğŸ”„ è§¦å‘ Failover è‡ªåŠ¨é‡è¯•               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ 5xx     â”‚ ğŸ”¥ å…¶ä»–æœåŠ¡å™¨é”™è¯¯                               â”‚  â”‚
â”‚  â”‚         â”‚ â”œâ”€ è®°å½•é”™è¯¯                                     â”‚  â”‚
â”‚  â”‚         â”‚ â””â”€ ğŸ”„ è§¦å‘ Failover è‡ªåŠ¨é‡è¯•                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  ğŸ”„ Failover è‡ªåŠ¨é‡è¯•æœºåˆ¶ (v1.1.0 æ–°å¢):                        â”‚
â”‚     â”œâ”€ å¯ç”¨æ¡ä»¶: FAILOVER_ENABLED=true (é»˜è®¤å¯ç”¨)              â”‚
â”‚     â”œâ”€ å¯é‡è¯•çŠ¶æ€ç : 500/502/503/504/529 (å¯é…ç½®)              â”‚
â”‚     â”œâ”€ æœ€å¤§é‡è¯•æ¬¡æ•°: FAILOVER_MAX_RETRIES (é»˜è®¤3æ¬¡)            â”‚
â”‚     â”œâ”€ è´¦æˆ·ä¸´æ—¶ä¸å¯ç”¨: FAILOVER_TEMP_UNAVAILABLE_TTL (é»˜è®¤5åˆ†é’Ÿ) â”‚
â”‚     â”œâ”€ æµå¼è¯·æ±‚ä¿æŠ¤: å·²å‘é€å“åº”å¤´åˆ™ä»…æ ‡è®°ï¼Œä¸é‡è¯•               â”‚
â”‚     â””â”€ ä¸“å±è´¦æˆ·å›é€€: ä¸“å±è´¦æˆ·å¤±è´¥åè‡ªåŠ¨å›é€€åˆ°å…±äº«æ±              â”‚
â”‚                                                                 â”‚
â”‚  âš ï¸ å…¶ä»–å³æ—¶é‡è¯•åœºæ™¯ (api.js å±‚):                               â”‚
â”‚     CONSOLE_ACCOUNT_CONCURRENCY_FULL â†’ æ¸…é™¤ä¼šè¯ â†’ é‡æ–°è°ƒåº¦(1æ¬¡) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 6: æˆåŠŸå“åº”å¤„ç†

### éæµå¼å“åº” (stream = false)

```
ä¸Šæ¸¸è¿”å› 200/201
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£ Usage æ•°æ®æ•è·                       â”‚
â”‚                                         â”‚
â”‚  ä»å“åº”ä½“æå–:                            â”‚
â”‚  â”œâ”€ input_tokens                        â”‚
â”‚  â”œâ”€ output_tokens                       â”‚
â”‚  â”œâ”€ cache_creation_input_tokens         â”‚
â”‚  â””â”€ cache_read_input_tokens             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£ æˆæœ¬è®¡ç®—                             â”‚
â”‚                                         â”‚
â”‚  costCalculator.calculateCost():         â”‚
â”‚  â”œâ”€ è·å–æ¨¡å‹ä»·æ ¼ (pricingService)        â”‚
â”‚  â”œâ”€ è®¡ç®— input/output æˆæœ¬               â”‚
â”‚  â””â”€ è®¡ç®—ç¼“å­˜ç›¸å…³æˆæœ¬                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£ ä½¿ç”¨ç»Ÿè®¡è®°å½• (å¼‚æ­¥)                   â”‚
â”‚                                         â”‚
â”‚  queueRateLimitUpdate():                 â”‚
â”‚  â”œâ”€ æ›´æ–°è¯·æ±‚è®¡æ•°                          â”‚
â”‚  â”œâ”€ æ›´æ–° Token è®¡æ•°                       â”‚
â”‚  â”œâ”€ æ›´æ–°è´¹ç”¨è®¡æ•°                          â”‚
â”‚  â”œâ”€ æ›´æ–°æ¯æ—¥/æ€»è´¹ç”¨                       â”‚
â”‚  â””â”€ æ›´æ–° Opus å‘¨è´¹ç”¨ (å¦‚é€‚ç”¨)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ï¸âƒ£ é”™è¯¯çŠ¶æ€æ¸…é™¤                          â”‚
â”‚                                         â”‚
â”‚  å¦‚æœè¯·æ±‚æˆåŠŸ:                            â”‚
â”‚  â”œâ”€ clearUnauthorizedErrors(accountId)   â”‚
â”‚  â”œâ”€ clearInternalErrors(accountId)       â”‚
â”‚  â”œâ”€ removeAccountRateLimit() (å¦‚ä¹‹å‰é™æµ) â”‚
â”‚  â””â”€ removeAccountOverload() (å¦‚ä¹‹å‰è¿‡è½½)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5ï¸âƒ£ å“åº”è¿”å›                             â”‚
â”‚                                         â”‚
â”‚  res.status(200).json({                  â”‚
â”‚    id: "msg_...",                        â”‚
â”‚    type: "message",                      â”‚
â”‚    role: "assistant",                    â”‚
â”‚    content: [...],                       â”‚
â”‚    model: "claude-3-5-sonnet-20241022",  â”‚
â”‚    stop_reason: "end_turn",              â”‚
â”‚    usage: { ... }                        â”‚
â”‚  })                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æµå¼å“åº” (stream = true)

```
ä¸Šæ¸¸è¿”å› 200ï¼Œå¼€å§‹ SSE æµ
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£ è®¾ç½®æµå¼å“åº”å¤´                        â”‚
â”‚                                         â”‚
â”‚  res.setHeader('Content-Type',           â”‚
â”‚                'text/event-stream')      â”‚
â”‚  res.setHeader('Cache-Control', 'no-cache') â”‚
â”‚  res.setHeader('X-Accel-Buffering', 'no')â”‚
â”‚  res.socket.setNoDelay(true)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£ SSE äº‹ä»¶é€å—è½¬å‘                      â”‚
â”‚                                         â”‚
â”‚  event: message_start                    â”‚
â”‚  data: {...}                            â”‚
â”‚                                         â”‚
â”‚  event: content_block_start              â”‚
â”‚  data: {...}                            â”‚
â”‚                                         â”‚
â”‚  event: content_block_delta (å¤šæ¬¡)       â”‚
â”‚  data: {"delta": {"text": "..."}}       â”‚
â”‚                                         â”‚
â”‚  event: message_delta (åŒ…å« usage)       â”‚
â”‚  data: {"usage": {...}}                 â”‚
â”‚                                         â”‚
â”‚  event: message_stop                     â”‚
â”‚  data: {...}                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£ Usage æ•°æ®æ•è·                       â”‚
â”‚                                         â”‚
â”‚  ä» message_delta äº‹ä»¶è§£æ:              â”‚
â”‚  â”œâ”€ input_tokens                        â”‚
â”‚  â”œâ”€ output_tokens                       â”‚
â”‚  â”œâ”€ cache_creation_input_tokens         â”‚
â”‚  â””â”€ cache_read_input_tokens             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ï¸âƒ£ æˆæœ¬è®¡ç®—å’Œç»Ÿè®¡ (å¼‚æ­¥)                 â”‚
â”‚                                         â”‚
â”‚  ä¸é˜»å¡å“åº”:                              â”‚
â”‚  â”œâ”€ costCalculator.calculateCost()       â”‚
â”‚  â”œâ”€ updateRateLimitCounters()            â”‚
â”‚  â””â”€ æ›´æ–°è´¦æˆ·ä½¿ç”¨ç»Ÿè®¡                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5ï¸âƒ£ è¿æ¥å…³é—­                             â”‚
â”‚                                         â”‚
â”‚  æ­£å¸¸å…³é—­:                               â”‚
â”‚  â””â”€ res.end()                           â”‚
â”‚                                         â”‚
â”‚  å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­ (req.on('close')):        â”‚
â”‚  â”œâ”€ decrementConcurrency()              â”‚
â”‚  â”œâ”€ abortController.abort()             â”‚
â”‚  â””â”€ è¿”å› 499 (ä¸å‘é€ç»™å®¢æˆ·ç«¯)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Œæ•´é”™è¯¯ç æ±‡æ€»

### å®¢æˆ·ç«¯é”™è¯¯ (4xx)

| çŠ¶æ€ç  | é”™è¯¯åç§° | è§¦å‘æ¡ä»¶ | å“åº”ç¤ºä¾‹ |
|-------|---------|---------|---------|
| **400** | Bad Request | è¯·æ±‚ä½“æ— æ•ˆã€ç¼ºå¤±å¿…éœ€å­—æ®µã€JSON æ ¼å¼é”™è¯¯ | `{error: "message required"}` |
| **401** | Unauthorized | API Key ç¼ºå¤±/æ— æ•ˆ/è¿‡æœŸ/è¢«ç¦ç”¨ | `{error: "Invalid API key"}` |
| **403** | Forbidden | æƒé™ä¸è¶³ã€å®¢æˆ·ç«¯å—é™ã€æ¨¡å‹å—é™ã€ä¸“å±è´¦æˆ·é™æµã€è´¦æˆ·è¢«å° | `{error: "Permission denied"}` |
| **413** | Request Entity Too Large | è¯·æ±‚ä½“è¶…è¿‡ 60MB | `{error: "Request body too large"}` |
| **429** | Too Many Requests | å¹¶å‘/è¯·æ±‚æ•°/Token/è´¹ç”¨é™åˆ¶ | `{error, limit, resetAt}` |
| **499** | Client Closed Request | å®¢æˆ·ç«¯åœ¨å“åº”å®Œæˆå‰å…³é—­è¿æ¥ (æµå¼) | æ— å“åº” (ä»…è®°å½•) |

### æœåŠ¡å™¨é”™è¯¯ (5xx)

| çŠ¶æ€ç  | é”™è¯¯åç§° | è§¦å‘æ¡ä»¶ | å“åº”ç¤ºä¾‹ |
|-------|---------|---------|---------|
| **500** | Internal Server Error | ä¸­é—´ä»¶å¼‚å¸¸ã€Tokenåˆ·æ–°å¤±è´¥ã€æ— å¯ç”¨è´¦æˆ·(æœªæ•è·) | `{error: "Internal error"}` |
| **501** | Not Implemented | count_tokens å¯¹ CCR/Bedrock ä¸æ”¯æŒ | `{error: "Not supported"}` |
| **502** | Bad Gateway | ä¸Šæ¸¸è¿æ¥é‡ç½®ã€DNSå¤±è´¥ã€è¿æ¥æ‹’ç» | `{error: "Bad gateway"}` |
| **503** | Service Unavailable | Console è´¦æˆ·å¹¶å‘æ»¡ | `{error: "No available accounts"}` |
| **504** | Gateway Timeout | ä¸Šæ¸¸è¯·æ±‚è¶…æ—¶ | `{error: "Gateway timeout"}` |
| **529** | Over Capacity | Claude API è¿‡è½½ (Claude ç‰¹æœ‰) | `{error: "Overloaded"}` |

---

## ç‰¹æ®Šè·¯ç”±å¤„ç†

### count_tokens è·¯ç”± (/v1/messages/count_tokens)

```
âš ï¸ è·³è¿‡ä»¥ä¸‹æ£€æŸ¥ (skipKeyRestrictions = true):
â”œâ”€ å®¢æˆ·ç«¯é™åˆ¶æ£€æŸ¥
â”œâ”€ å¹¶å‘é™åˆ¶æ£€æŸ¥
â”œâ”€ é€Ÿç‡é™åˆ¶æ£€æŸ¥
â”œâ”€ æ¯æ—¥/æ€»è´¹ç”¨é™åˆ¶æ£€æŸ¥
â””â”€ Opus å‘¨è´¹ç”¨é™åˆ¶æ£€æŸ¥

ç‰¹æ®Šå¤„ç†:
â”œâ”€ CCR/Bedrock è´¦æˆ· â†’ 501 Not Implemented
â”œâ”€ Console è´¦æˆ·ä¸æ”¯æŒ â†’ è¿”å› { input_tokens: 0 }
â””â”€ å®¢æˆ·ç«¯å…³é—­ â†’ 499 (ä»…è®°å½•)
```

---

## Redis Key ç»“æ„å‚è€ƒ

```
# API Key ç›¸å…³
api_key:{keyId}                    â†’ Key è¯¦æƒ… (åŠ å¯†)
api_key_hash:{sha256_hash}         â†’ keyId æ˜ å°„ (å¿«é€ŸæŸ¥è¯¢)
api_key_usage:{keyId}              â†’ ä½¿ç”¨ç»Ÿè®¡
api_key_cost:{keyId}               â†’ æˆæœ¬ç»Ÿè®¡

# é€Ÿç‡é™åˆ¶
rate_limit:window_start:{keyId}    â†’ çª—å£å¼€å§‹æ—¶é—´
rate_limit:requests:{keyId}        â†’ è¯·æ±‚è®¡æ•°
rate_limit:tokens:{keyId}          â†’ Token è®¡æ•°
rate_limit:cost:{keyId}            â†’ è´¹ç”¨è®¡æ•°

# å¹¶å‘æ§åˆ¶
concurrency:{keyId}                â†’ Sorted Set {requestId: timestamp}

# è´¦æˆ·ç›¸å…³
claude_account:{accountId}         â†’ è´¦æˆ·ä¿¡æ¯ (åŠ å¯†)
claude_account:{accountId}:401_errors â†’ 401 é”™è¯¯è®¡æ•°
overload:{accountId}               â†’ è¿‡è½½æ ‡è®° (TTL è‡ªåŠ¨è¿‡æœŸ)
rate_limit_state:{accountId}       â†’ é™æµçŠ¶æ€
temp_unavailable:{accountId}       â†’ ä¸´æ—¶ä¸å¯ç”¨æ ‡è®° (Failover TTL: FAILOVER_TEMP_UNAVAILABLE_TTL)

# ç²˜æ€§ä¼šè¯
unified_claude_session_mapping:{hash} â†’ {accountId, accountType, timestamp}
```

